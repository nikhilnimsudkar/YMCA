package com.ymca.web.controller;

//import java.security.Principal;
import java.io.StringBufferInputStream;
import java.io.StringReader;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.Enumeration;
import java.util.List;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathFactory;

import net.sf.json.JSONArray;
import net.sf.json.JSONObject;

import org.apache.commons.httpclient.HttpClient;
import org.apache.commons.httpclient.methods.InputStreamRequestEntity;
import org.apache.commons.httpclient.methods.PostMethod;
import org.apache.commons.lang3.RandomStringUtils;
import org.apache.commons.lang3.time.DateFormatUtils;
/*import jxl.Workbook;
import jxl.WorkbookSettings;
import jxl.write.Label;
import jxl.write.NumberFormat;
import jxl.write.WritableCellFormat;
import jxl.write.WritableFont;
import jxl.write.WritableSheet;
import jxl.write.WritableWorkbook;
*/
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ExtendedModelMap;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.ModelAndView;
import org.w3c.dom.Document;
import org.xml.sax.InputSource;

import com.ymca.dao.AccountDao;
import com.ymca.dao.InvoiceDao;
import com.ymca.dao.JetPayPaymentDao;
import com.ymca.dao.PaymentDao;
import com.ymca.dao.PaymentMethodDao;
import com.ymca.dao.SignupDao;
import com.ymca.dao.SystemPropertyDao;
import com.ymca.model.Account;
import com.ymca.model.Invoice;
import com.ymca.model.JetPayPayment;
import com.ymca.model.Payment;
import com.ymca.model.PaymentMethod;
import com.ymca.model.Signup;
import com.ymca.model.SystemProperty;
import com.ymca.model.User;
import com.ymca.web.enums.ACH_AccountTypeEnum;
import com.ymca.web.enums.JetpayTransactionTypeEnum;
import com.ymca.web.enums.PaymentMethodTypeEnum;
import com.ymca.web.enums.PaymentTypeEnum;
import com.ymca.web.enums.PortalStatusEnum;
import com.ymca.web.util.Constants;

@SuppressWarnings("deprecation")
@Controller
public class PaymentController extends BaseController {
	
	@Resource
	private AccountDao accountDao;
	
	@Resource
	private PaymentMethodDao paymentMethodDao;
	
	@Resource
	private JetPayPaymentDao jetPayPaymentDao;
	
	@Resource
	private PaymentDao paymentDao;
	
	@Resource
	private SystemPropertyDao systemPropertyDao;
	
	@Resource
	private InvoiceDao invoiceDao;
	
	@Resource
	private SignupDao signupDao;
	
	
	@RequestMapping(value="/viewPaymentHistory", method=RequestMethod.GET)
    public String viewPaymentHistory(final HttpServletRequest request, final HttpServletResponse response) { 
        return "viewPaymentHistory";
    }
	
	@RequestMapping(value="/viewPaymentInformation", method=RequestMethod.GET)
    public ModelAndView viewPaymentInformation(final HttpServletRequest request, final HttpServletResponse response) {
		Model model = new ExtendedModelMap();
		try{
			
			Authentication a = SecurityContextHolder.getContext().getAuthentication();
			String userId = null;
			try{
				userId = ((UserDetails) a.getPrincipal()).getUsername();
			}catch(Exception e){
				model.addAttribute("errMsg", "Your session is expired");
				return new ModelAndView("viewPaymentInformation", model.asMap());
			}
			
			Account account = null;
	    	User user =  null;	    	
	    	List<PaymentMethod> paymentMethodList = null;
	    	List<SystemProperty> systemPropertyLst = null;   
	    	if(userId != null && !"".equals(userId)){
		    	account = accountDao.getByEmail(userId);
				request.setAttribute("userId", userId);				
				user = getUserByAccount(account, user);
				paymentMethodList = paymentMethodDao.getPaymentMethodListForAccountID(account.getAccountId());
				//paymentMethodList = account.getPaymentMethod();
				systemPropertyLst = systemPropertyDao.getByPicklistName(Constants.PAYMENT_METHOD_PICKLIST_NAME);
	    	}
			//PHistory start
			Date startDate = new Date();  
			  Calendar cal =  Calendar.getInstance();
			  cal.setTime(startDate);
			  cal.add(Calendar.DAY_OF_YEAR, -3);
			  //Date formattedStartDate = cal.getTime();
			  
			  Date endDate = new Date();
			  Calendar cal1 =  Calendar.getInstance();
			  cal1.setTime(endDate);
			  cal1.add(Calendar.DAY_OF_YEAR, 3);
			  //Date formattedEndDate = cal1.getTime();
			  
			  /*List<Payment> payments = new ArrayList<>();
			  List<Object> paymentLst = null;
			  //paymentLst = paymentDao.getPaymentHistory("Credit","Failure","Kate","winslet",4L, formattedStartDate,formattedEndDate);
					  if(userId != null && !"".equals(userId)){
					    	account = accountDao.getByEmail(userId);
							request.setAttribute("userId", userId);				
							user = getUserByAccount(account, user);
							paymentList = account.getPaymentMethod();
							//paymentLst =paymentDao.getPaymentHistory("Credit","Failure","kwinslet",account.getAccountId(), formattedStartDate,formattedEndDate);
							for(Object payment1 : paymentLst){
								   Object objArr1[] = (Object[]) payment1;  
								  // objArr1[1]=String.format("%.2f",objArr1[1]);
								 //  objArr1[3]=objArr1[3].toString().substring(0, 10);
								   if(objArr1[4].toString().equalsIgnoreCase("Failure")){
									   objArr1[4]=(objArr1[4]+"("+objArr1[5]+")");
								   }else{
									   objArr1[4]=objArr1[4];
								   }
								   Payment payment= new Payment();
								   Signup signup = new Signup();
								   Product item = new Product();		   
								   signup.setItem(item);
								   payment.setSignup(signup);
								   item.setCategory(objArr1[0].toString());
								   //payment.getSignup().getItem().setCategory(objArr1[0].toString());
								   payment.setCategory(objArr1[0].toString());
								   payment.setAmount(Double.valueOf(objArr1[1].toString()));
								   payment.setType(objArr1[2].toString());
								   DateFormat formatter = new SimpleDateFormat("yyyy-MM-dd");
								   Date pDate = null;
								try {
									pDate = formatter.parse(objArr1[3].toString());
								} catch (ParseException e) {
									e.printStackTrace();
								}
								   payment.setPaymentDate(pDate);
								   payment.setStatus(objArr1[4].toString());
								   payment.setReason(objArr1[5].toString());
								   payments.add(payment);
							  }	
				    	}*/
			  
			 /* System.out.println("Size:"+payments.size());
			  for(Payment payment2 : payments) {
					System.out.println("-----------------------------------------------------------------------");
					System.out.println("Program:"+payment2.getCategory()+"  Amount:"+payment2.getAmount()+"  Type:"+payment2.getType()+"  Date:"+payment2.getPaymentDate()+"  Status:"+payment2.getStatus()+"  Reason:"+payment2.getReason());
			  }*/
			//Phistory end
	  	
	    	if(account != null){	    		    	    	
		        model.addAttribute("accInfo", account);
		        model.addAttribute("usInfo", user);	
		        int userCount = account.getUser().size();
		        List<User> userS = new ArrayList<User>();
		        int countmembers = 0;
		        if(userCount>1){
			        for(User u: account.getUser()){
			        	if(!user.getUsername().equalsIgnoreCase(u.getUsername()) && u.isActive()){
			        		countmembers = countmembers + 1;
			        		userS.add(u);
			        	}
			        }
				}
		        String contextPath = request.getContextPath();
		        model.addAttribute("contextPath", contextPath);
		        model.addAttribute("userCount", countmembers);
		        model.addAttribute("userS", userS);
		        model.addAttribute("paymentInfoLst" , paymentMethodList);	
		       // model.addAttribute("paymentList", payments);
		        model.addAttribute("systemPropertyLst", systemPropertyLst);
		        model.addAttribute("AccountID", account.getAccountId());
		        
	    	}else {
				model.addAttribute("errMsg", "Please Login");
				return new ModelAndView("login", model.asMap());			
	    	}
		}catch(Exception e){
			e.printStackTrace();
			model.addAttribute("errMsg", "Please Login");
			return new ModelAndView("login", model.asMap());
		}
	        
		return new ModelAndView("viewPaymentInformation", model.asMap());
    }
	
	@RequestMapping(value="getPaymentHistoryBySearchCriteria", method=RequestMethod.GET)
	public @ResponseBody String getPaymentHistoryBySearchCriteria(@RequestParam(value="pType") String pType,@RequestParam(value="pStatus") String pStatus,
				@RequestParam(value="username") String username,@RequestParam(value="stDate") String stDate,@RequestParam(value="eDate") String eDate,
				final HttpServletRequest request, final HttpServletResponse response) {
		
        try { 
        	List<Object> paymentLst=new ArrayList<>();
        	JSONArray json = new JSONArray();
        	Authentication a = SecurityContextHolder.getContext().getAuthentication();
    		String userId = null;
    		userId = ((UserDetails) a.getPrincipal()).getUsername();    		
    		Account account = null;       
    		
    		SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd");
    		Date startDate=format.parse(stDate);   		
    		Date endDate=format.parse(eDate);
        	if(userId != null && !"".equals(userId)){
    	    	account = accountDao.getByEmail(userId);
    	    	
    	    	if(pType.equalsIgnoreCase("ALL") && pStatus.equalsIgnoreCase("ALL")){
        			paymentLst = paymentDao.getPaymentHistoryByName(username,account.getAccountId(),startDate,endDate); 
        		}
        		else if(pType.equalsIgnoreCase("ALL")){
        			paymentLst = paymentDao.getPaymentHistoryByNameandstatus(pStatus,username,account.getAccountId(),startDate,endDate); 
        		}
        		else if(pStatus.equalsIgnoreCase("ALL")){
        			paymentLst = paymentDao.getPaymentHistoryByNameandtype(pType,username,account.getAccountId(),startDate,endDate); 
        			//pStatus = "Success,Failure,Pending";
        			/*StringBuilder prodStatus = new StringBuilder();
        			prodStatus.append("\'");
        			prodStatus.append("Success");
        			prodStatus.append("\'");
        			prodStatus.append(",");
        			prodStatus.append("\'");
        			prodStatus.append("Failure");
        			prodStatus.append("\'");
        			prodStatus.append(",");
        			prodStatus.append("\'");
        			prodStatus.append("Pending");
        			prodStatus.append("\'");
        			pStatus = prodStatus.toString();*/
        		}
        		else{
        			paymentLst = paymentDao.getPaymentHistoryByName(pType,pStatus,username,account.getAccountId(),startDate,endDate);  
        		}
    	    	
    	    		for(Object product : paymentLst){
    	    		       Object objArr1[] = (Object[]) product;
    	    		       if(objArr1 != null && objArr1.length >0){
    	    		        JSONObject obj = new JSONObject();
    	    		        if(objArr1[0] != null){
    	    		         obj.put("program", objArr1[0].toString());
    	    		        }
    	    		        if(objArr1[1] != null){
    	    		        	objArr1[1]=String.format("%.2f",objArr1[1]);
    	    		         obj.put("amount", objArr1[1].toString());
    	    		        }
    	    		     if(objArr1[2] != null){
    	    		      obj.put("type", objArr1[2].toString());   
    	    		     }
    	    		     if(objArr1[3] != null){
    	    		    	 /*objArr1[3]=objArr1[3].toString().substring(0, 10);
    	    		      obj.put("paymentDate", objArr1[3].toString());*/
    	    		    	 String dateSample = objArr1[3].toString();;
    		    		 	    String oldFormat = "yyyy-MM-dd HH:mm:ss";
    		    		 	    String newFormat = "MM/dd/yyyy";
    		    		 	    SimpleDateFormat sdf1 = new SimpleDateFormat(oldFormat);
    		    		 	    SimpleDateFormat sdf2 = new SimpleDateFormat(newFormat);
    		    		 	    System.out.println(sdf2.format(sdf1.parse(dateSample)));
    		    		 	    String pDate=sdf2.format(sdf1.parse(dateSample));
    		    		 	    obj.put("paymentDate", pDate);
    	    		     }
    	    		     if(objArr1[4] != null){
    	    		    	 if(objArr1[4].toString().equalsIgnoreCase("Failure") && objArr1[5] != null ){
								   objArr1[4]=(objArr1[4]+"("+objArr1[5]+")");
							   }else{
								   objArr1[4]=objArr1[4];
							   }
    	    		      obj.put("status", objArr1[4].toString());
    	    		     }
    	    		     if(objArr1[6] != null && objArr1[7] != null){
     	    		    	
       	    		      obj.put("contact", objArr1[6].toString() + " " + objArr1[7].toString());
       	    		     }
    	    		     json.add(obj);
    	    		       }     
    	    		      }     
    	    		      System.out.println(json.toString());
    	    		      System.out.println("Size:"+paymentLst.size());
    	    		      return json.toString();        
            }           
        }catch(Exception e){      
            System.out.println("Error occoured while querying Product");
                  e.printStackTrace();          
           }
        return null; 
    }
	
	@RequestMapping(value="getPaymentHistoryBySearchCriteriaExcludingName", method=RequestMethod.GET)
	public @ResponseBody String getPaymentHistoryBySearchCriteriaExcludingName(@RequestParam(value="pType") String pType,
			@RequestParam(value="pStatus") String pStatus,@RequestParam(value="stDate") String stDate,@RequestParam(value="eDate") String eDate,
				final HttpServletRequest request, final HttpServletResponse response) {
		
        try { 
        	List<Object> paymentLst=new ArrayList<>();
        	JSONArray json = new JSONArray();
        	Authentication a = SecurityContextHolder.getContext().getAuthentication();
    		String userId = null;
    		userId = ((UserDetails) a.getPrincipal()).getUsername();    		
    		Account account = null;        	
    		System.out.println("Type: "+pType+" Status: "+pStatus+" stDate: "+stDate+" edate: "+eDate);
    		SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd");
    		Date startDate=format.parse(stDate);   		
    		Date endDate=format.parse(eDate);
    		
        	if(userId != null && !"".equals(userId)){
    	    	account = accountDao.getByEmail(userId);
 		       paymentLst = paymentDao.getPaymentHistory(pType,pStatus,account.getAccountId(),startDate,endDate);
    	    	for(Object product : paymentLst){
	    		       Object objArr1[] = (Object[]) product;
	    		       if(objArr1 != null && objArr1.length >0){
	    		        JSONObject obj = new JSONObject();
	    		        if(objArr1[0] != null){
	    		         obj.put("program", objArr1[0].toString());
	    		        }
	    		        if(objArr1[1] != null){
	    		        	objArr1[1]=String.format("%.2f",objArr1[1]);
	    		         obj.put("amount", objArr1[1].toString());
	    		        }
	    		     if(objArr1[2] != null){
	    		      obj.put("type", objArr1[2].toString());   
	    		     }
	    		     if(objArr1[3] != null){
	    		    	 //objArr1[3]=objArr1[3].toString().substring(0, 10);	    		    	 
	    		    	String dateSample = objArr1[3].toString();;
	    		 	    String oldFormat = "yyyy-MM-dd HH:mm:ss";
	    		 	    String newFormat = "MM/dd/yyyy";
	    		 	    SimpleDateFormat sdf1 = new SimpleDateFormat(oldFormat);
	    		 	    SimpleDateFormat sdf2 = new SimpleDateFormat(newFormat);
	    		 	    System.out.println(sdf2.format(sdf1.parse(dateSample)));
	    		 	    String pDate=sdf2.format(sdf1.parse(dateSample));
	    		 	    obj.put("paymentDate", pDate);
	    		     }
	    		     if(objArr1[4] != null){
	    		    	 if(objArr1[4].toString().equalsIgnoreCase("Failure") && objArr1[5] != null ){
							   objArr1[4]=(objArr1[4]+"("+objArr1[5]+")");
						   }else{
							   objArr1[4]=objArr1[4];
						   }
	    		      obj.put("status", objArr1[4].toString());
	    		     }
	    		     json.add(obj);
	    		       }     
	    		      } 
    	    	 System.out.println(json.toString());
   		      System.out.println("Size:"+paymentLst.size());
   		      return json.toString();  
            }            
        } catch (Exception se) {        	
            System.out.println("Error occoured");
            se.printStackTrace();
        }
       return null;
    }
	/*@RequestMapping(value="getPaymentHistoryBySearchCriteria", method=RequestMethod.GET)
	//@RequestMapping(value="getPaymentHistoryBySearchCriteria/{pType}/{pStatus}/{username}/{stDate}/{eDate}", method=RequestMethod.GET)
    public @ResponseBody List<Object> getPaymentHistoryBySearchCriteria(@PathVariable String pType,@PathVariable String pStatus,@PathVariable String username,
    		@PathVariable String stDate,@PathVariable String eDate,final HttpServletRequest request, final HttpServletResponse response) {
	public @ResponseBody List<Object> getPaymentHistoryBySearchCriteria(@RequestParam(value="pType") String pType,@RequestParam(value="pStatus") String pStatus,
				@RequestParam(value="username") String username,@RequestParam(value="stDate") String stDate,@RequestParam(value="eDate") String eDate,
				final HttpServletRequest request, final HttpServletResponse response) {
		List<Object> paymentLst=new ArrayList<>();
        try { 
        	Authentication a = SecurityContextHolder.getContext().getAuthentication();
    		String userId = null;
    		userId = ((UserDetails) a.getPrincipal()).getUsername();    		
    		Account account = null;        	
    		System.out.println("Type"+pType+pStatus+username+stDate);
    		SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd");
    		Date startDate=format.parse(stDate);   		
    		Date endDate=format.parse(eDate);
        	if(userId != null && !"".equals(userId)){
    	    	account = accountDao.getByEmail(userId);
    	    	//if(null!=username && !(username.isEmpty()) ){
    	    		paymentLst = paymentDao.getPaymentHistoryByName(pType,pStatus,username,account.getAccountId(),startDate,endDate);    	    		
    	    	}else{
    	    		paymentLst = paymentDao.getPaymentHistory(pType,pStatus,account.getAccountId(),startDate,endDate);	
    	    	}   	    	
    	    	System.out.println("Size:"+paymentLst.size());
            }           
        } catch (Exception se) {        	
            System.out.println("Error occoured");
            se.printStackTrace();
            return null;
        }
       return paymentLst;
    }*/
	
	/*@RequestMapping(value="getPaymentHistoryBySearchCriteriaExcludingName", method=RequestMethod.GET)
	//@RequestMapping(value="getPaymentHistoryBySearchCriteria/{pType}/{pStatus}/{username}/{stDate}/{eDate}", method=RequestMethod.GET)
    public @ResponseBody List<Object> getPaymentHistoryBySearchCriteria(@PathVariable String pType,@PathVariable String pStatus,@PathVariable String username,
    		@PathVariable String stDate,@PathVariable String eDate,final HttpServletRequest request, final HttpServletResponse response) {
	public @ResponseBody List<Object> getPaymentHistoryBySearchCriteriaExcludingName(@RequestParam(value="pType") String pType,@RequestParam(value="pStatus") String pStatus,
				@RequestParam(value="stDate") String stDate,@RequestParam(value="eDate") String eDate,
				final HttpServletRequest request, final HttpServletResponse response) {
		List<Object> paymentLst=new ArrayList<>();
        try { 
        	Authentication a = SecurityContextHolder.getContext().getAuthentication();
    		String userId = null;
    		userId = ((UserDetails) a.getPrincipal()).getUsername();    		
    		Account account = null;        	
    		System.out.println("Type"+pType+pStatus+stDate);
    		SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd");
    		Date startDate=format.parse(stDate);   		
    		Date endDate=format.parse(eDate);
        	if(userId != null && !"".equals(userId)){
    	    	account = accountDao.getByEmail(userId);
    	    	//if(null!=username && !(username.isEmpty()) ){
    	    		//paymentLst = paymentDao.getPaymentHistoryByName(pType,pStatus,username,account.getAccountId(),startDate,endDate);    	    		
    	    	//}else{
    	    		paymentLst = paymentDao.getPaymentHistory(pType,pStatus,account.getAccountId(),startDate,endDate);	
    	    	//}   	    	
    	    	System.out.println("Size:"+paymentLst.size());
            }            
        } catch (Exception se) {        	
            System.out.println("Error occoured");
            se.printStackTrace();
            return null;
        }
       return paymentLst;
    }*/
	
	@RequestMapping(value="/export/{pType}/{pStatus}/{username}/{stDate}/{eDate}", method=RequestMethod.GET)
    public @ResponseBody List<Object> export(@PathVariable String pType,@PathVariable String pStatus,@PathVariable String username,
    		@PathVariable String stDate,@PathVariable String eDate,final HttpServletRequest request, final HttpServletResponse response) { 
		System.out.println("export to excel ");
		//Calendar calendar = Calendar.getInstance();
		//File file;
		// Export excel file location
		//String path = "d:/exportToExcel.xls";
		List<Object> list=new ArrayList<>();
		
		/*Label lbl;
		Iterator itr = null;*/		
        try { 
        	Authentication a = SecurityContextHolder.getContext().getAuthentication();
    		String userId = null;
    		//SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd");
    		//Date startDate=format.parse(stDate);   		
    		//Date endDate=format.parse(eDate);
    		userId = ((UserDetails) a.getPrincipal()).getUsername();    		
    		//Account account = null;        	
        	if(userId != null && !"".equals(userId)){
    	    	//account = accountDao.getByEmail(userId);
    	    	//list=paymentDao.getPaymentHistory("Credit","Failure","kwinslet",account.getAccountId(), startDate,endDate);
            
        	// Excel file properties
        				/*file = new File(path);
        				if (!file.exists()) {
        					file.createNewFile();
        				}
        				WorkbookSettings wbSettings = new WorkbookSettings();
        				wbSettings.setLocale(new Locale("en", "EN"));
        				WritableWorkbook w = Workbook.createWorkbook(file, wbSettings);
        				w.createSheet("Table Data", 0);
        				WritableSheet s = w.getSheet(0);
        				WritableFont wf = new WritableFont(WritableFont.ARIAL, 10,WritableFont.NO_BOLD);
        				WritableCellFormat cf = new WritableCellFormat(wf);
        				cf.setWrap(true);

        				//itr = forecasts.iterator();
        				List<String> listOfColumns = new ArrayList<String>();
        				listOfColumns.add("Program");
        				listOfColumns.add("Amount");
        				listOfColumns.add("Type");
        				listOfColumns.add("Payment Date");
        				listOfColumns.add("Status");			

        				// Write column header
        				int col = 0;
        				for (int j = 0; j < listOfColumns.size(); j++) {
        					lbl = new Label(col, 0, listOfColumns.get(j), cf);
        					s.addCell(lbl);
        					col++;
        				}
        				
        				int drow = 1;
        				Number number = null;
        				//NumberFormat
        				NumberFormat onedps = new NumberFormat("#.#");
        				WritableCellFormat onedpsFormat = new WritableCellFormat();
        				
        				for(drow = 1;drow<=list.size(); drow++){
        					for (int column = 0; column < 7; column++) {
        						String str = list.get(drow-1).toString();
        						String[] cells = str.split(",");
        						lbl = new Label(column, drow, cells[column], cf);					
        						s.addCell(lbl);				
        					}
        				}
        				w.write();
        				w.close();
*/        	}
        } catch (Exception se) {        	
            System.out.println("Error occoured");
            se.printStackTrace();
            return null;
        }
       return list;
    }
	
	/*@RequestMapping(value="/updateCardInfo/{paymentId}", method=RequestMethod.GET)
    public @ResponseBody PaymentMethod updateCardInfo(@PathVariable Long paymentId, final HttpServletRequest request, final HttpServletResponse response) { 
		Model model = new ExtendedModelMap();
		List<PaymentMethod> paymentMethod = paymentMethodDao.getPaymentMethodByPaymentId(paymentId);
        try {            
            model.addAttribute("paymentMethod", new PaymentMethod());
            if(paymentMethod != null && !paymentMethod.isEmpty()){
            	PaymentMethod pm = paymentMethod.get(0);
            	Account customer =  new Account();
            	customer.setAccountId(pm.getCustomer().getAccountId());
            	pm.setCustomer(customer);
            	return pm;
            }
            
        } catch (Exception se) {
            System.out.println("Error occoured");
            se.printStackTrace();
        }
       return null;
    }*/
	
	/*@RequestMapping(value="/updateCardInfo", method=RequestMethod.POST)
    public @ResponseBody String updateCardInfoSubmit(PaymentMethod paymentMethod, final HttpServletRequest request, final HttpServletResponse response) {		
        try {            
			PaymentMethod payMethod = paymentMethodDao.getOne(paymentMethod.getPaymentId());			
			if(payMethod != null){				
				payMethod.setBillingAddressLine1(paymentMethod.getBillingAddressLine1());
				payMethod.setBillingAddressLine2(paymentMethod.getBillingAddressLine2());
				payMethod.setBillingCity(paymentMethod.getBillingCity());
				payMethod.setBillingState(paymentMethod.getBillingState());
				
				
				payMethod.setExpirationMonth(paymentMethod.getExpirationMonth());
				payMethod.setExpirationYear(paymentMethod.getExpirationYear());
				
				paymentMethodDao.save(payMethod);
				return "SUCCESS";	
			}else{
				return "NOT_FOUND";	
			}
			           
        } catch (Exception se) {
            System.out.println("Error occoured");
            se.printStackTrace();
            return "FAIL";
        }       
    }*/
	
	/*@RequestMapping(value="/updateBankInfo/{paymentId}", method=RequestMethod.GET)
    public @ResponseBody PaymentMethod updateBankInfo(@PathVariable Long paymentId, final HttpServletRequest request, final HttpServletResponse response) { 
		Model model = new ExtendedModelMap();
		List<PaymentMethod> paymentMethod = paymentMethodDao.getPaymentMethodByPaymentId(paymentId);
        try {            
            model.addAttribute("paymentMethod", new PaymentMethod());
            if(paymentMethod != null && !paymentMethod.isEmpty()){
            	PaymentMethod pm = paymentMethod.get(0);
            	Account customer =  new Account();
            	customer.setAccountId(pm.getCustomer().getAccountId());
            	pm.setCustomer(customer);
            	return pm;
            }
            
        } catch (Exception se) {
            System.out.println("Error occoured");
            se.printStackTrace();
        }
       return null;       
    }*/
	
	/*@RequestMapping(value="/updateBankInfo", method=RequestMethod.POST)
    public @ResponseBody String updateBankInfoSubmit(PaymentMethod paymentMethod, final HttpServletRequest request, final HttpServletResponse response) {		
        try {            
        	PaymentMethod payMethod = paymentMethodDao.getOne(paymentMethod.getPaymentId());			
			if(payMethod != null){
				payMethod.setBillingAddressLine1(paymentMethod.getBillingAddressLine1());
				payMethod.setBillingAddressLine2(paymentMethod.getBillingAddressLine2());
				payMethod.setBillingCity(paymentMethod.getBillingCity());
				payMethod.setBillingState(paymentMethod.getBillingState());			
				paymentMethodDao.save(payMethod);
				return "SUCCESS";	
			}else{
				return "NOT_FOUND";	
			}
			           
        } catch (Exception se) {
            System.out.println("Error occoured");
            se.printStackTrace();
            return "FAIL";
        }       
    }*/
	
	/*@RequestMapping(value="/addBankInfo", method=RequestMethod.POST)
    public @ResponseBody String addBankInfoSubmit(PaymentMethod paymentMethod, final HttpServletRequest request, final HttpServletResponse response) {		
		try {
			if (paymentMethod != null) {
				boolean flag = false;
				Authentication a = SecurityContextHolder.getContext().getAuthentication();
				String userId = null;
				userId = ((UserDetails) a.getPrincipal()).getUsername();
				Account account = null;
				User user = null;
				List<PaymentMethod> paymentList = null;
				if (userId != null && !"".equals(userId)) {
					account = accountDao.getByEmail(userId);
					if (account != null && account.getAccountId() != null) {
						List<PaymentMethod> paymentMethodLst = paymentMethodDao.getPaymentByAccountId(account.getAccountId());
						if (paymentMethodLst != null && !paymentMethodLst.isEmpty()) {
							for (PaymentMethod pm : paymentMethodLst) {
								if (pm.getIsPrimary().equals(1)) {
									flag = true;
								}
							}
						}
						paymentMethod.setCustomer(account);
					}
					if (flag) {
						paymentMethod.setIsPrimary(0);
					} else {
						paymentMethod.setIsPrimary(1);
					}
					paymentMethod.setPortalStatus(Constants.PAYMENT_METHOD_PORTAL_STATUS);
					paymentMethod.setPaymentType(Constants.PAYMENT_METHOD_PAYMENT_METHOD_EFT);
					paymentMethodDao.save(paymentMethod);

				}
				return "SUCCESS";
			} else {
				return "FAIL";
			}

		} catch (Exception se) {
			System.out.println("Error occoured");
			se.printStackTrace();
			return "FAIL";
		}     
    }*/
	
	/*@RequestMapping(value="/addCardInfo", method=RequestMethod.POST)
    public @ResponseBody String addCardInfoSubmit(PaymentMethod paymentMethod, final HttpServletRequest request, final HttpServletResponse response) {		
        try {    		
				if(paymentMethod != null){	
						boolean flag = false;			
						Authentication a = SecurityContextHolder.getContext().getAuthentication();
						String userId = null;
						userId = ((UserDetails) a.getPrincipal()).getUsername();				
						Account account = null;
				    	User user =  null;	    	
				    	List<PaymentMethod> paymentList = null;
				    	if(userId != null && !"".equals(userId)){
					    	account = accountDao.getByEmail(userId);
					    	if(account != null && account.getAccountId() != null){
					    		List<PaymentMethod> paymentMethodLst = paymentMethodDao.getPaymentByAccountId(account.getAccountId());        	
					            if(paymentMethodLst != null && !paymentMethodLst.isEmpty()){
					            	for(PaymentMethod pm :paymentMethodLst){
					            		if(pm.getIsPrimary().equals(1)){
					            			flag = true;
					            		}
					            	}
					    	}
					    	paymentMethod.setCustomer(account);
				    	}
				    	if(flag){
					    	paymentMethod.setIsPrimary(0);
					    }else{
					    	paymentMethod.setIsPrimary(1);
					    }	
				    	paymentMethod.setPortalStatus(Constants.PAYMENT_METHOD_PORTAL_STATUS);
				    	paymentMethod.setPaymentType(Constants.PAYMENT_METHOD_PAYMENT_METHOD_CREDIT);
				    	
				    	if(paymentMethod.getCardNumber().trim().length()==16){
				    		String cc_num = paymentMethod.getCardNumber().trim().substring(12);
				    		cc_num = Constants.CC_MASKED_FIRST_12_DIGIT + cc_num; 
				    		paymentMethod.setCardNumber(cc_num);
				    		
				    	}
				    	else{
				    		return "FAIL";	
				    	}
				    	
				    	PaymentMethod pm = paymentMethodDao.save(paymentMethod);
				    	return "SUCCESS__S__"+pm.getPaymentId().toString();	
			    	}
				    	
				}
				return "FAIL";	
					
			
        } catch (Exception se) {
            System.out.println("Error occoured");
            se.printStackTrace();
            return "FAIL";
        }       
    }*/
	
	/*@RequestMapping(value="/removeCardInfo/{paymentId}", method=RequestMethod.GET)
    public @ResponseBody String removeCardInfo(@PathVariable Long paymentId, final HttpServletRequest request, final HttpServletResponse response) { 
		Model model = new ExtendedModelMap();		
        try { 
        	List<PaymentMethod> paymentMethod = paymentMethodDao.getPaymentMethodByPaymentId(paymentId);
            model.addAttribute("paymentMethod", new PaymentMethod());
            if(paymentMethod != null && !paymentMethod.isEmpty()){
            	PaymentMethod pm = paymentMethod.get(0);
            	Account customer =  new Account();
            	customer.setAccountId(pm.getCustomer().getAccountId());
            	pm.setCustomer(customer);
            	pm.setPortalStatus(Constants.PAYMENT_METHOD_PORTAL_STATUS_REMOVE);
            	paymentMethodDao.save(pm);            	
            	return "SUCCESS";
            }
            
        } catch (Exception se) {        	
            System.out.println("Error occoured");
            se.printStackTrace();
            return "NOT_FOUND";
        }
       return null;
    }
	
	@RequestMapping(value="/removeBankInfo/{paymentId}", method=RequestMethod.GET)
    public @ResponseBody String removeBankInfo(@PathVariable Long paymentId, final HttpServletRequest request, final HttpServletResponse response) { 
		Model model = new ExtendedModelMap();		
        try { 
        	List<PaymentMethod> paymentMethod = paymentMethodDao.getPaymentMethodByPaymentId(paymentId);
            model.addAttribute("paymentMethod", new PaymentMethod());
            if(paymentMethod != null && !paymentMethod.isEmpty()){
            	PaymentMethod pm = paymentMethod.get(0);
            	Account customer =  new Account();
            	customer.setAccountId(pm.getCustomer().getAccountId());
            	pm.setCustomer(customer);
            	pm.setPortalStatus(Constants.PAYMENT_METHOD_PORTAL_STATUS_REMOVE);
            	paymentMethodDao.save(pm);   
            	return "SUCCESS";
            }
            
        } catch (Exception se) {        	
            System.out.println("Error occoured");
            se.printStackTrace();
            return "NOT_FOUND";
        }
       return null;
    }*/
	
	/*@RequestMapping(value="/updatePaymentMethodPrimary/{paymentId}", method=RequestMethod.GET)
    public @ResponseBody String updatePaymentMethodPrimary(@PathVariable Long paymentId, final HttpServletRequest request, final HttpServletResponse response) { 
				
        try { 
        	Authentication a = SecurityContextHolder.getContext().getAuthentication();
    		String userId = null;
    		userId = ((UserDetails) a.getPrincipal()).getUsername();    		
    		Account account = null;        	
        	if(userId != null && !"".equals(userId)){
    	    	account = accountDao.getByEmail(userId);
	        	List<PaymentMethod> paymentMethodLst = paymentMethodDao.getPaymentByAccountId(account.getAccountId());        	
	            if(paymentMethodLst != null && !paymentMethodLst.isEmpty()){
	            	for(PaymentMethod pm :paymentMethodLst){
	            		if(paymentId !=null && pm.getPaymentId().equals(paymentId)){
	            			pm.setIsPrimary(1);
	            		}else{
	            			pm.setIsPrimary(0);
	            		}
	            		paymentMethodDao.save(pm);
	            	}           	
	            	return "SUCCESS";
	            }
            }
            
        } catch (Exception se) {        	
            System.out.println("Error occoured");
            se.printStackTrace();
            return "NOT_FOUND";
        }
       return null;
    }
	*/
	@RequestMapping(value="/ProcessDirectPayment", method=RequestMethod.POST)
    public void insertPaymentDetails(final HttpServletRequest request, final HttpServletResponse response) {
		System.out.println("in ProcessDirectPayment >>");
        try {
        	JetPayPayment jetPayPayment = new JetPayPayment();
        	jetPayPayment.setTransId(request.getParameter("transId"));
        	jetPayPayment.setJpReturnHash(request.getParameter("jp_return_hash"));
        	jetPayPayment.setResponseText(request.getParameter("responseText"));
        	jetPayPayment.setCid(request.getParameter("cid"));
        	jetPayPayment.setName(request.getParameter("name"));
        	jetPayPayment.setCardNum(request.getParameter("cardNum"));
        	jetPayPayment.setCard(request.getParameter("card"));
        	if(request.getParameter("amount") != null && !"".equals(request.getParameter("amount").trim())){
        		jetPayPayment.setAmount(Double.valueOf(request.getParameter("amount")));
        	}else{
        		jetPayPayment.setAmount(0D);
        	}
        	jetPayPayment.setFeeAmount(request.getParameter("feeAmount"));        	
        	jetPayPayment.setActCode(request.getParameter("actCode"));
        	jetPayPayment.setApprCode(request.getParameter("apprCode"));
        	jetPayPayment.setCvvMatch(request.getParameter("cvvMatch"));
        	jetPayPayment.setAddressMatch(request.getParameter("addressMatch"));
        	jetPayPayment.setZipMatch(request.getParameter("zipMatch"));
        	jetPayPayment.setAvsMatch(request.getParameter("avsMatch"));
        	jetPayPayment.setCcToken(request.getParameter("ccToken"));
        	jetPayPayment.setOldToken(request.getParameter("oldToken"));
        	jetPayPayment.setCustomerEmail(request.getParameter("customerEmail"));
        	jetPayPayment.setOrderNumber(request.getParameter("order_number"));
        	jetPayPayment.setBillingAddress1(request.getParameter("billingAddress1"));
        	jetPayPayment.setBillingAddress2(request.getParameter("billingAddress2"));
        	jetPayPayment.setBillingCity(request.getParameter("billingCity"));
        	jetPayPayment.setBillingState(request.getParameter("billingState"));
        	jetPayPayment.setBillingZip(request.getParameter("billingZip"));
        	jetPayPayment.setBillingCountry(request.getParameter("billingCountry"));
        	jetPayPayment.setPaymentType(Constants.PAYMENT_CREDIT_CARD);
        	
        	jetPayPaymentDao.save(jetPayPayment);			           
        	
        } catch (Exception se) {
            System.out.println("Error occoured");
            se.printStackTrace();
        }
    }
	
	@RequestMapping(value="/processPaymentMethod", method=RequestMethod.POST)
    public void processPaymentMethod(final HttpServletRequest request, final HttpServletResponse response) {
		System.out.println("in processPaymentMethod >>");
        try {     
        	
        	JetPayPayment jetPayPayment = new JetPayPayment();
        	jetPayPayment.setTransId(request.getParameter("transId"));
        	jetPayPayment.setJpReturnHash(request.getParameter("jp_return_hash"));
        	jetPayPayment.setResponseText(request.getParameter("responseText"));
        	jetPayPayment.setCid(request.getParameter("cid"));
        	jetPayPayment.setName(request.getParameter("name"));
        	jetPayPayment.setCardNum(request.getParameter("cardNum"));
        	jetPayPayment.setCard(request.getParameter("card"));
        	if(request.getParameter("amount") != null && !"".equals(request.getParameter("amount").trim())){
        		jetPayPayment.setAmount(Double.valueOf(request.getParameter("amount")));
        	}else{
        		jetPayPayment.setAmount(0D);
        	}
        	jetPayPayment.setFeeAmount(request.getParameter("feeAmount"));        	
        	jetPayPayment.setActCode(request.getParameter("actCode"));
        	jetPayPayment.setApprCode(request.getParameter("apprCode"));
        	jetPayPayment.setCvvMatch(request.getParameter("cvvMatch"));
        	jetPayPayment.setAddressMatch(request.getParameter("addressMatch"));
        	jetPayPayment.setZipMatch(request.getParameter("zipMatch"));
        	jetPayPayment.setAvsMatch(request.getParameter("avsMatch"));
        	jetPayPayment.setCcToken(request.getParameter("ccToken"));
        	jetPayPayment.setOldToken(request.getParameter("oldToken"));
        	jetPayPayment.setCustomerEmail(request.getParameter("customerEmail"));
        	jetPayPayment.setOrderNumber(request.getParameter("order_number"));
        	jetPayPayment.setBillingAddress1(request.getParameter("billingAddress1"));
        	jetPayPayment.setBillingAddress2(request.getParameter("billingAddress2"));
        	jetPayPayment.setBillingCity(request.getParameter("billingCity"));
        	jetPayPayment.setBillingState(request.getParameter("billingState"));
        	jetPayPayment.setBillingZip(request.getParameter("billingZip"));
        	jetPayPayment.setBillingCountry(request.getParameter("billingCountry"));
        	
        	jetPayPaymentDao.save(jetPayPayment);
        	
        	if(request.getParameter("ccToken") != null && !request.getParameter("ccToken").equals("")){
        		
        		if(request.getParameter("oldToken") != null && !request.getParameter("oldToken").equals("")){
        			PaymentMethod oldPaymentMethod = paymentMethodDao.getByOldToken(request.getParameter("oldToken"));
        			oldPaymentMethod.setPortalStatus(PortalStatusEnum.INACTIVE.toString());
        			paymentMethodDao.save(oldPaymentMethod);
        		}
        		
	        	PaymentMethod paymentMethod = new PaymentMethod();
	        	paymentMethod.setPaymentType(PaymentMethodTypeEnum.CREDIT.toString());
	        	paymentMethod.setPortalStatus(PortalStatusEnum.ACTIVE.toString());
	        	paymentMethod.setTransId(request.getParameter("transId"));
	        	paymentMethod.setCardNumber(Constants.CARD_MASKED_FIRST_DIGITS+request.getParameter("cardNum"));
	        	paymentMethod.setCardType(request.getParameter("card"));
	        	paymentMethod.setExpirationMonth(request.getParameter("merData0"));
	        	paymentMethod.setExpirationYear(request.getParameter("merData1"));
	        	paymentMethod.setFullName(request.getParameter("name"));
	        	paymentMethod.setTokenNumber(request.getParameter("ccToken"));
	        	paymentMethod.setOldToken(request.getParameter("oldToken"));
	        	paymentMethod.setOrderNumber(request.getParameter("order_number"));
	        	paymentMethod.setBillingAddressLine1(request.getParameter("billingAddress1"));
	        	paymentMethod.setBillingAddressLine2(request.getParameter("billingAddress2"));
	        	paymentMethod.setBillingCity(request.getParameter("billingCity"));
	        	paymentMethod.setBillingState(request.getParameter("billingState"));
	        	paymentMethod.setBillingZip(request.getParameter("billingZip"));
	        	paymentMethod.setNickName(request.getParameter("ud2"));
	        	
	        	Account acc = new Account();
	        	acc.setAccountId(new Long(request.getParameter("ud1")));
	        	paymentMethod.setCustomer(acc);
	        	paymentMethod.setBillingCountry(request.getParameter("billingCountry"));
	        	
	        	// TODO: For testing only
	        	StringBuffer testData = new StringBuffer();
	        	Enumeration<String> requestParameters = request.getParameterNames();
	            while (requestParameters.hasMoreElements()) {
	                String paramName = (String) requestParameters.nextElement();
	                testData.append(paramName);
	                //out.println("Request Paramter Name: " + paramName+ ", Value - " + request.getParameter(paramName));
	            }
	        	paymentMethod.setOldToken(testData.toString());
	        	
	        	paymentMethodDao.save(paymentMethod);
        	}
        	System.out.println("in processPaymentMethod done ");
        	
        } catch (Exception se) {
            System.out.println("Error occoured");
            se.printStackTrace();
        }
    }
	
	@RequestMapping(value="/viewPaymentForm", method=RequestMethod.GET)
    public String viewPaymentForm(final HttpServletRequest request, final HttpServletResponse response) {
		System.out.println("in viewPaymentForm >>");
        return "viewPaymentForm";
    }
	
	@RequestMapping(value="/redirectSuccess", method=RequestMethod.GET)
    public String redirectSuccess(final HttpServletRequest request, final HttpServletResponse response) {
		System.out.println("in redirectSuccess >>");
        return "redirectSuccess";
    }
	
	@RequestMapping(value="/redirectFailure", method=RequestMethod.GET)
    public String redirectFailure(final HttpServletRequest request, final HttpServletResponse response) {
		System.out.println("in redirectFailure >>");
        return "redirectFailure";
    }
	
	/*@RequestMapping(value="/addcard", method=RequestMethod.GET)
    public String addcard(final HttpServletRequest request, final HttpServletResponse response) { 
        return "addcard";
    }*/
	
	
	/*@RequestMapping(value="/getPaymentDetailsByOrderId/{orderNumber}", method=RequestMethod.GET)
    public @ResponseBody JetPayPayment getPaymentDetailsByOrderId(@PathVariable String orderNumber, final HttpServletRequest request, final HttpServletResponse response) {
		System.out.println("in ProcessDirectPayment >>");
		JetPayPayment jetPayPayment = new JetPayPayment();       	
        try {         	
        	jetPayPayment = jetPayPaymentDao.getByOrderNumber(orderNumber);			           
        	System.out.println(jetPayPayment.getActCode());
        	System.out.println(jetPayPayment.getResponseText());
        } catch (Exception se) {
            System.out.println("Error occoured");
            System.out.println(se.getLocalizedMessage());
            System.out.println(se.getMessage());
            System.out.println(se.getCause());
            se.printStackTrace();
            
        }
		return jetPayPayment;		     
    }*/
	
	@RequestMapping(value="/viewPaymentInformationByLoggedInUser", method=RequestMethod.GET)
    public @ResponseBody List<PaymentMethod>  viewPaymentInformationByLoggedInUser(final HttpServletRequest request, final HttpServletResponse response) {
		
		Authentication a = SecurityContextHolder.getContext().getAuthentication();
		String userId = null;
		try{
			userId = ((UserDetails) a.getPrincipal()).getUsername();
		}catch(Exception e){
			System.out.println("Your session is expired");			
		}
		
		Account account = null;
    	//User user =  null;	    	
    	List<PaymentMethod> paymentList = null;    	 
    	if(userId != null && !"".equals(userId)){
	    	account = accountDao.getByEmail(userId);		
			paymentList = paymentMethodDao.getCreditCardInfoByAccountId(account.getAccountId());		
    	}        
		return paymentList;
    }
	
	@RequestMapping(value="/getACHPaymentInformationByLoggedInUser", method=RequestMethod.GET)
    public @ResponseBody List<PaymentMethod>  getACHPaymentInformationByLoggedInUser(final HttpServletRequest request, final HttpServletResponse response) {
		
		Authentication a = SecurityContextHolder.getContext().getAuthentication();
		String userId = null;
		try{
			userId = ((UserDetails) a.getPrincipal()).getUsername();
		}catch(Exception e){
			System.out.println("Your session is expired");			
		}
		
		Account account = null;    		
    	List<PaymentMethod> paymentList = null;    	 
    	if(userId != null && !"".equals(userId)){
	    	account = accountDao.getByEmail(userId);		
			paymentList = paymentMethodDao.getACHInfoByAccountId(account.getAccountId());		
    	}        
		return paymentList;
    }
	
	@RequestMapping(value="/processPaymentByTokenId", method=RequestMethod.POST)
    public @ResponseBody JetPayPayment  processPaymentByTokenId(@RequestParam("token") String token, @RequestParam("totalAmount") String totalAmount,final HttpServletRequest request, final HttpServletResponse response) {
		// Get target URL
	    String strURL = "https://test1.jetpay.com/jetpay";	    
	    // Prepare HTTP post
	    PostMethod post = new PostMethod(strURL);	    
	    StringBuffer inputXMLStrBuffer = new StringBuffer("<JetPay>");
	    inputXMLStrBuffer.append("<TransactionID>"+RandomStringUtils.randomAlphanumeric(18)+"</TransactionID>");	
	    inputXMLStrBuffer.append("<TransactionType>AUTHONLY</TransactionType>");       
	    inputXMLStrBuffer.append("<Token>"+token+"</Token>");
	    inputXMLStrBuffer.append("<TotalAmount>"+totalAmount+"</TotalAmount>");
	    inputXMLStrBuffer.append("<TerminalID>TESTTERMINAL</TerminalID>");
	    inputXMLStrBuffer.append("</JetPay>");	    
	    // Request content will be retrieved directly
	    // from the input stream
	    // Per default, the request content needs to be buffered
	    // in order to determine its length.
	    // Request body buffering can be avoided when
	    // content length is explicitly specified
	    post.setRequestEntity(new InputStreamRequestEntity(new StringBufferInputStream(inputXMLStrBuffer.toString())));
	    //, inputXMLStrBuffer.toString().length())

	    // Specify content type and encoding
	    // If content encoding is not explicitly specified
	    // ISO-8859-1 is assumed
	    post.setRequestHeader("Content-type", "text/xml; charset=ISO-8859-1");
	    // Get HTTP client
	    HttpClient httpclient = new HttpClient();
	    // Execute request
	    JetPayPayment jetPayPayment =  new JetPayPayment();
	    try {
	    	httpclient.executeMethod(post);
	        String xml = post.getResponseBodyAsString();  
	        if(xml != null){
	        	
            InputSource source = new InputSource(new StringReader(xml));

            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
            DocumentBuilder db = dbf.newDocumentBuilder();
            Document document = db.parse(source);

            XPathFactory xpathFactory = XPathFactory.newInstance();
            XPath xpath = xpathFactory.newXPath();  
            
            jetPayPayment.setTransId(xpath.evaluate("/JetPayResponse/TransactionID", document));
            jetPayPayment.setActCode(xpath.evaluate("/JetPayResponse/ActionCode", document));
            jetPayPayment.setResponseText(xpath.evaluate("/JetPayResponse/ResponseText", document));
	        }
	    } catch(Exception e){
	    	e.printStackTrace();
	    	
	    } finally {
	        // Release current connection to the connection pool 
	        // once you are done
	        post.releaseConnection();
	    }
		return jetPayPayment;
    }
	
	@RequestMapping(value="/processACHPayment", method=RequestMethod.POST)
    public @ResponseBody JetPayPayment processACHPayment(@RequestParam("bankAccountNumber") String bankAccountNumber, @RequestParam("bankRoutingNumber") String bankRoutingNumber, @RequestParam("checkNumber") String checkNumber, @RequestParam("cardName") String cardName, @RequestParam("totalAmt") String totalAmt, final HttpServletRequest request, final HttpServletResponse response) {
		String strURL = "https://test1.jetpay.com/jetpay";         
		// New ACH Transaction
		PostMethod post = new PostMethod(strURL);    

		StringBuffer inputXMLStrBuffer = new StringBuffer("<JetPay>");
		inputXMLStrBuffer.append("<TransactionType>CHECK</TransactionType>");
		inputXMLStrBuffer.append("<TerminalID>TESTMERCHANT</TerminalID>");
		inputXMLStrBuffer.append("<TransactionID>"+RandomStringUtils.randomAlphanumeric(18)+"</TransactionID>");
		inputXMLStrBuffer.append("<CardName>"+ cardName +"</CardName>");
		inputXMLStrBuffer.append("<TotalAmount>"+ totalAmt +"</TotalAmount>");
		//inputXMLStrBuffer.append("<FeeAmount>100</FeeAmount>");
		inputXMLStrBuffer.append("<ACH Type=\"SAVINGS\" SEC=\"PPD\">");
		inputXMLStrBuffer.append("<AccountNumber>"+ bankAccountNumber +"</AccountNumber>");
		inputXMLStrBuffer.append("<ABA>"+ bankRoutingNumber +"</ABA>");
		inputXMLStrBuffer.append("<CheckNumber>"+ checkNumber +"</CheckNumber>");
		inputXMLStrBuffer.append("</ACH>");
		inputXMLStrBuffer.append("</JetPay>");
		// Request content will be retrieved directly
		// from the input stream
		// Per default, the request content needs to be buffered
		// in order to determine its length.
		// Request body buffering can be avoided when
		// content length is explicitly specified
		post.setRequestEntity(new InputStreamRequestEntity(new StringBufferInputStream(inputXMLStrBuffer.toString())));
		//, inputXMLStrBuffer.toString().length())

		// Specify content type and encoding
		// If content encoding is not explicitly specified
		// ISO-8859-1 is assumed
		post.setRequestHeader("Content-type", "text/xml; charset=ISO-8859-1");

		// Get HTTP client
		HttpClient httpclient = new HttpClient();

		// Execute request
		JetPayPayment jetPayPayment =  new JetPayPayment();
		try {

			int result = httpclient.executeMethod(post);

			// Display status code
			System.out.println("Response status code: " + result);

			// Display response
			System.out.println("Response body: ");
			System.out.println(post.getResponseBodyAsString());
			
			String xml = post.getResponseBodyAsString();           
			InputSource source = new InputSource(new StringReader(xml));

			DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
			DocumentBuilder db = dbf.newDocumentBuilder();
			Document document = db.parse(source);

			XPathFactory xpathFactory = XPathFactory.newInstance();
			XPath xpath = xpathFactory.newXPath();

			jetPayPayment.setTransId(xpath.evaluate("/JetPayResponse/TransactionID", document));
            jetPayPayment.setActCode(xpath.evaluate("/JetPayResponse/ActionCode", document));
            jetPayPayment.setApprCode(xpath.evaluate("/JetPayResponse/Approval", document));
            jetPayPayment.setResponseText(xpath.evaluate("/JetPayResponse/ResponseText", document));
            
		} catch(Exception e){
			e.printStackTrace();
			
		} finally {
			// Release current connection to the connection pool 
			// once you are done
			post.releaseConnection();
		}
		
		
		return jetPayPayment;		
	}	
	
	
	@RequestMapping(value="/processACHPaymentByTokenId", method=RequestMethod.POST)
    public @ResponseBody JetPayPayment processACHPaymentByTokenId(@RequestParam("token") String token, @RequestParam("totalAmount") String totalAmount,  @RequestParam("checkNumber") String checkNumber, @RequestParam("cardName") String cardName, final HttpServletRequest request, final HttpServletResponse response) {
		String strURL = "https://test1.jetpay.com/jetpay";         
		// New ACH Transaction
		PostMethod post = new PostMethod(strURL);    

		StringBuffer inputXMLStrBuffer = new StringBuffer("<JetPay>");
		inputXMLStrBuffer.append("<TransactionID>"+RandomStringUtils.randomAlphanumeric(18)+"</TransactionID>");
		inputXMLStrBuffer.append("<TransactionType> CHECK </TransactionType>");
		inputXMLStrBuffer.append("<TerminalID> TESTTERMINAL </TerminalID>");
		inputXMLStrBuffer.append("<Origin> INTERNET </Origin>");
		inputXMLStrBuffer.append("<TotalAmount> "+ totalAmount +" </TotalAmount>");
		//inputXMLStrBuffer.append("<FeeAmount>100</FeeAmount>");
		inputXMLStrBuffer.append("<CardName> " + cardName +" </CardName>");
		inputXMLStrBuffer.append("<Token> " +token+ "</Token>");
		inputXMLStrBuffer.append("<ACH>");
		inputXMLStrBuffer.append("<CheckNumber> "+ checkNumber +" </CheckNumber>");
		inputXMLStrBuffer.append("</ACH>");
		inputXMLStrBuffer.append("</JetPay>");
		// Request content will be retrieved directly
		// from the input stream
		// Per default, the request content needs to be buffered
		// in order to determine its length.
		// Request body buffering can be avoided when
		// content length is explicitly specified
		post.setRequestEntity(new InputStreamRequestEntity(new StringBufferInputStream(inputXMLStrBuffer.toString())));
		//, inputXMLStrBuffer.toString().length())

		// Specify content type and encoding
		// If content encoding is not explicitly specified
		// ISO-8859-1 is assumed
		post.setRequestHeader("Content-type", "text/xml; charset=ISO-8859-1");

		// Get HTTP client
		HttpClient httpclient = new HttpClient();

		// Execute request
		JetPayPayment jetPayPayment =  new JetPayPayment();
		try {

			int result = httpclient.executeMethod(post);

			// Display status code
			System.out.println("Response status code: " + result);

			// Display response
			System.out.println("Response body: ");
			System.out.println(post.getResponseBodyAsString());
			
			String xml = post.getResponseBodyAsString();           
			InputSource source = new InputSource(new StringReader(xml));

			DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
			DocumentBuilder db = dbf.newDocumentBuilder();
			Document document = db.parse(source);

			XPathFactory xpathFactory = XPathFactory.newInstance();
			XPath xpath = xpathFactory.newXPath();

			jetPayPayment.setTransId(xpath.evaluate("/JetPayResponse/TransactionID", document));
            jetPayPayment.setActCode(xpath.evaluate("/JetPayResponse/ActionCode", document));
            jetPayPayment.setResponseText(xpath.evaluate("/JetPayResponse/ResponseText", document));
            
		} catch(Exception e){
			e.printStackTrace();
			
		} finally {
			// Release current connection to the connection pool 
			// once you are done
			post.releaseConnection();
		}
		
		
		return jetPayPayment;		
	}	
	
	@RequestMapping(value="/payNow", method=RequestMethod.GET)
    public ModelAndView PayNow(final HttpServletRequest request, final HttpServletResponse response) { 
		Model model = new ExtendedModelMap();
		Authentication a = SecurityContextHolder.getContext().getAuthentication();
		String userId = null;
		try{
			userId = ((UserDetails) a.getPrincipal()).getUsername();
		}catch(Exception e){
			model.addAttribute("errMsg", "Your session is expired");
			return new ModelAndView("viewPaymentInformation", model.asMap());
		}
		
		Account account = null;
    	User user =  null;	    	
    	
    	if(userId != null && !"".equals(userId)){
	    	account = accountDao.getByEmail(userId);
			request.setAttribute("userId", userId);				
			user = getUserByAccount(account, user);
			
    	}
		
    	if(account != null){	    		    	    	
	        model.addAttribute("accInfo", account);
	        model.addAttribute("usInfo", user);	
	        int userCount = account.getUser().size();
	        List<User> userS = new ArrayList<User>();
	        int countmembers = 0;
	        if(userCount>1){
		        for(User u: account.getUser()){
		        	if(!user.getUsername().equalsIgnoreCase(u.getUsername()) && u.isActive()){
		        		countmembers = countmembers + 1;
		        		userS.add(u);
		        	}
		        }
			}
	        model.addAttribute("userCount", countmembers);
	        model.addAttribute("userS", userS);
	        
	     // Invoice start

	     			// CurrentDue
	     			Date startDate = new Date();
	     			Calendar cal = Calendar.getInstance();
	     			cal.setTime(startDate);
	     			cal.add(Calendar.DAY_OF_YEAR, -14);
	     			//Date formattedStartDate = cal.getTime();

	     			Date endDate = new Date();
	     			Calendar cal1 = Calendar.getInstance();
	     			cal1.setTime(endDate);
	     			cal1.add(Calendar.DAY_OF_YEAR, 14);
	     			Date formattedEndDate = cal1.getTime();

	     			List<Invoice> invoiceList = null;
	     			List<Payment> paymentList = null;
	     			 List<Invoice> requiredInvoiceList = new ArrayList<Invoice>();
	     			double invoiceAmount = 0;
	     			
	     		

	     			invoiceList = invoiceDao.getInvoiceByCustomer(
	     					account.getAccountId(), startDate, formattedEndDate);
	     			for (Invoice invoice : invoiceList) {
	     				double paymentAmount = 0;  				
	     				invoiceAmount = invoice.getAmount();
	     				System.out.println(" invoice id & invoiceAmount in side if --  " +invoice.getInvoiceId()+"-->> "+ invoiceAmount);
	     				System.out.println("paymentAmount- if -  " + paymentAmount);
	     				paymentList = paymentDao.getPaymentAmount(invoice
	     						.getInvoiceId());

	     				for (Payment payment : paymentList) {
	     					System.out.println("paymrent id & paymentAmount- if -if   " + payment.getTransactionId()+"  -->> "+ paymentAmount);
	     					paymentAmount += payment.getAmount();

	     				}
	     				System.out.println("paymentAmount--  " + paymentAmount);
	     				if(invoiceAmount>paymentAmount)
	     				{
	     					double balance=invoiceAmount-paymentAmount;
	     					System.out.println(" BALANCE --->> "+balance);
	     					invoice.setBalance(invoiceAmount-paymentAmount);
	     				    requiredInvoiceList.add(invoice);
	     				}
	     			}
	     			model.addAttribute("requiredInvoiceList", requiredInvoiceList);
	     			
	     			System.out.println("invoiceAmount--  " + invoiceAmount);
	     			
	     		
	     			double invoicePastAmount = 0;
	     	//		double paymentPastAmount = 0;
	     			 List<Invoice> requiredPastInvoiceList = new ArrayList<Invoice>();

	     			invoiceList = invoiceDao.getInvoicePastDueByCustomer(
	     					account.getAccountId(), startDate);
	     			for (Invoice invoice : invoiceList) {
	     				double paymentPastAmount = 0;
	     				invoicePastAmount= invoice.getAmount();

	     				
	     				System.out.println("PAST invoice id & invoiceAmount in side if --  " +invoice.getInvoiceId()+"-->> "+ invoicePastAmount);
	     				System.out.println("PAST paymentAmount- if -  " + paymentPastAmount);
	     				paymentList = paymentDao.getPaymentAmount(invoice
	     						.getInvoiceId());

	     				for (Payment payment : paymentList) {
	     					System.out.println("PAST payment id & paymentAmount- if -if   " + payment.getTransactionId()+"  -->> "+ paymentPastAmount);
	     					paymentPastAmount += payment.getAmount();

	     				}
	     				System.out.println("paymentPastAmount--  " + paymentPastAmount);
	     				if(invoicePastAmount>paymentPastAmount)
	     				{
	     				//	invoice
	     					double pastBalance=invoicePastAmount-paymentPastAmount;
	     					System.out.println(" PASTBalance --->> "+pastBalance);
	     					invoice.setBalance(invoicePastAmount-paymentPastAmount);
	     					requiredPastInvoiceList.add(invoice);
	     				}
	     			}
	     			model.addAttribute("requiredPastInvoiceList", requiredPastInvoiceList);
	     			System.out.println("invoicePastAmount--  " + invoicePastAmount);
	     			//System.out.println("paymentPastAmount--  " + paymentPastAmount);
	     			// Invoice end
	        
	            
    	}else {
			model.addAttribute("errMsg", "Please Login");
			return new ModelAndView("login", model.asMap());			
		}	        
	        
		return new ModelAndView("payNow", model.asMap());
    }
	
	@RequestMapping(value="/insertPaymentDetailsForAchTransaction", method=RequestMethod.POST)
    public void insertPaymentDetailsForAchTransaction(@RequestParam("bankAccountNumber") String bankAccountNumber, 
    		@RequestParam("bankRoutingNumber") String bankRoutingNumber, @RequestParam("checkNumber") String checkNumber, 
    		@RequestParam("cardName") String cardName, @RequestParam("totalAmt") String totalAmt, @RequestParam("transId") String transId,	
    		@RequestParam("responseText") String responseText, @RequestParam("actCode") String actCode, @RequestParam("apprCode") String apprCode, 
    		@RequestParam("billingAddress1") String billingAddress1, @RequestParam("billingAddress2") String billingAddress2, @RequestParam("billingCity") String billingCity,
    		@RequestParam("billingState") String billingState, @RequestParam("billingZip") String billingZip,
    		HttpServletRequest request, final HttpServletResponse response) {
		System.out.println("in ProcessDirectPayment >>");
        try {            
        	JetPayPayment jetPayPayment = new JetPayPayment();
        	jetPayPayment.setTransId(transId);
        	jetPayPayment.setOrderNumber(transId);
        	jetPayPayment.setBankAccountNumber(bankAccountNumber);
        	jetPayPayment.setResponseText(responseText);
        	jetPayPayment.setBankRoutingNumber(bankRoutingNumber);
        	jetPayPayment.setName(cardName);
        	jetPayPayment.setCheckNumber(checkNumber);
        	jetPayPayment.setActCode(actCode);
        	jetPayPayment.setApprCode(apprCode);
        	if(totalAmt != null && !"".equals(totalAmt.trim())){
        		jetPayPayment.setAmount(Double.valueOf(totalAmt));
        	}else{
        		jetPayPayment.setAmount(0D);
        	}
        	jetPayPayment.setBillingAddress1(billingAddress1);
        	jetPayPayment.setBillingAddress2(billingAddress2);      	
        	jetPayPayment.setBillingCity(billingCity);
        	jetPayPayment.setBillingState(billingState);
        	jetPayPayment.setBillingZip(billingZip);
        	jetPayPayment.setBillingCountry("USA");        	
        	jetPayPayment.setPaymentType(Constants.PAYMENT_ACH);
        	
        	jetPayPaymentDao.save(jetPayPayment);			           
        	
        } catch (Exception se) {
            System.out.println("Error occoured");
            System.out.println(se.getLocalizedMessage());
            System.out.println(se.getMessage());
            System.out.println(se.getCause());
            se.printStackTrace();
        }
    }
	
	@RequestMapping(value = "/getPaymentMethodByToken", method = RequestMethod.GET)
	public @ResponseBody String getPaymentMethodByToken(
			@RequestParam(value="token") String token, HttpServletRequest request,
			final HttpServletResponse response) {
		JSONObject json = new JSONObject();
		try {
			PaymentMethod paymentMethod = paymentMethodDao.getPaymentMethodByTokenNumber(token);
			if(paymentMethod != null){
				json.put("cardNumber", paymentMethod.getCardNumber());
				json.put("expirationMonth", paymentMethod.getExpirationMonth());
				json.put("expirationYear", paymentMethod.getExpirationYear());
				json.put("billingAddressLine1", paymentMethod.getBillingAddressLine1());
				json.put("billingAddressLine2", paymentMethod.getBillingAddressLine2());
				json.put("billingCity", paymentMethod.getBillingCity());
				json.put("billingCountry", paymentMethod.getBillingCountry());
				json.put("billingState", paymentMethod.getBillingState());
				json.put("billingZip", paymentMethod.getBillingZip());
				json.put("fullName", paymentMethod.getFullName());
				json.put("orderNumber", paymentMethod.getOrderNumber());
				json.put("securityCode", paymentMethod.getSecurityCode());
				json.put("nickName", paymentMethod.getNickName());
				json.put("portalStatus", paymentMethod.getPortalStatus());
			}
		} catch (Exception se) {
			System.out.println("Error occoured");
			se.printStackTrace();
		}
		return json.toString();
	}
	
	@RequestMapping(value = "/checkPaymentMethodStatus", method = RequestMethod.POST)
	public @ResponseBody String checkPaymentMethodStatus(
			@RequestParam(value = "orderNumber") String orderNumber,
			final HttpServletRequest request, final HttpServletResponse response) {
		StringBuffer resp = new StringBuffer();
		try {
			long endTimeMillis = System.currentTimeMillis() + 10000;
			while (true) {
				if (System.currentTimeMillis() < endTimeMillis) {
					
					JetPayPayment jetPayPayment = jetPayPaymentDao.getByOrderNumber(orderNumber);
					
					if(jetPayPayment != null 
							&& jetPayPayment.getActCode() != null
							&& !jetPayPayment.getActCode().equals("")){
						
						if(jetPayPayment.getActCode().equals(Constants.PAYMENT_ACTION_CODE_SUCCESS)){
							resp.append("SUCCESS__Token number: "+jetPayPayment.getCcToken());
						}else{
							resp.append("FAILURE__Action Code: "+jetPayPayment.getActCode()+" Error Message: "+jetPayPayment.getResponseText());
						}
						break;
					}
					
					// check status
					Thread.sleep(2000);
				}else{
					resp.append("FAILURE__");
					break;
				}
			}

		} catch (Exception se) {
			se.printStackTrace();
			resp.append("FAILURE__");
		}
		return resp.toString();
	}
	
	@RequestMapping(value = "/updateCardPaymentMethodByToken", method = RequestMethod.POST)
	public @ResponseBody String updateCardPaymentMethodByToken(
			@RequestParam("token") String token,
			@RequestParam("cardExpMonth") String cardExpMonth,
			@RequestParam("cardExpYear") String cardExpYear,
			@RequestParam("nickName") String nickName,
			/*@RequestParam("addressLine1") String addressLine1,
			@RequestParam("addressLine2") String addressLine2,
			@RequestParam("billingCity") String billingCity,
			@RequestParam("billingState") String billingState,
			@RequestParam("billingZip") String billingZip,*/
			final HttpServletRequest request, final HttpServletResponse response) {
		
		StringBuffer resp = new StringBuffer();
		PostMethod post = new PostMethod(Constants.JETPAY_XML_SCHEMA_URL);
		JetPayPayment jetPayPayment = new JetPayPayment();
		StringBuffer errMsg = new StringBuffer();
		try {
			// Prepare HTTP post
			StringBuffer inputXMLStrBuffer = new StringBuffer("<JetPay>");
			inputXMLStrBuffer.append("<TransactionID>" + RandomStringUtils.randomAlphanumeric(18) + "</TransactionID>");
			inputXMLStrBuffer.append("<TransactionType>" + JetpayTransactionTypeEnum.TOKENIZE + "</TransactionType>");
			inputXMLStrBuffer.append("<TerminalID>"	+ Constants.JETPAY_TERMINAL_ID + "</TerminalID>");
			inputXMLStrBuffer.append("<CardExpMonth>" + cardExpMonth	+ "</CardExpMonth>");
			inputXMLStrBuffer.append("<CardExpYear>" + cardExpYear + "</CardExpYear>");
			inputXMLStrBuffer.append("<Origin>" + "INTERNET" + "</Origin>");
			inputXMLStrBuffer.append("<Token Tokenize='true'>" + token + "</Token>");
			inputXMLStrBuffer.append("</JetPay>");
			post.setRequestEntity(new InputStreamRequestEntity(new StringBufferInputStream(inputXMLStrBuffer.toString())));
			post.setRequestHeader("Content-type","text/xml; charset=ISO-8859-1");

			HttpClient httpclient = new HttpClient();
			httpclient.executeMethod(post);
			String xml = post.getResponseBodyAsString();

			// parse response
			if (xml != null) {
				InputSource source = new InputSource(new StringReader(xml));
				DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
				DocumentBuilder db = dbf.newDocumentBuilder();
				Document document = db.parse(source);
				XPathFactory xpathFactory = XPathFactory.newInstance();
				XPath xpath = xpathFactory.newXPath();

				String actionCode = xpath.evaluate("/JetPayResponse/ActionCode", document);
				if(actionCode != null && !actionCode.equals("")){
					jetPayPayment.setActCode(actionCode);
					jetPayPayment.setTransId(xpath.evaluate("/JetPayResponse/TransactionID", document));
					jetPayPayment.setResponseText(xpath.evaluate("/JetPayResponse/ResponseText", document));
					jetPayPayment.setCcToken(xpath.evaluate("/JetPayResponse/Token", document));
					
					if(actionCode.equals(Constants.PAYMENT_ACTION_CODE_SUCCESS) && (jetPayPayment.getCcToken() != null && !jetPayPayment.getCcToken().equals(""))){
						jetPayPayment.setApprCode(xpath.evaluate("/JetPayResponse/Approval", document));
						
						// get old payment method
						PaymentMethod oldPaymentMethod = new PaymentMethod();
						oldPaymentMethod = paymentMethodDao.getPaymentMethodByTokenNumber(token);
						
						// Inactivate existing token
						oldPaymentMethod.setPortalStatus(PortalStatusEnum.INACTIVE.toString());
						paymentMethodDao.save(oldPaymentMethod);
						
						// persist new payment method
						PaymentMethod paymentMethod = new PaymentMethod();
						paymentMethod.setPaymentType(PaymentMethodTypeEnum.CREDIT.toString());
						paymentMethod.setPortalStatus(PortalStatusEnum.ACTIVE.toString());
						paymentMethod.setTokenNumber(jetPayPayment.getCcToken());
						paymentMethod.setTransId(jetPayPayment.getTransId());
						paymentMethod.setCustomer(oldPaymentMethod.getCustomer());
						paymentMethod.setFullName(oldPaymentMethod.getFullName());
						paymentMethod.setCardType(oldPaymentMethod.getCardType());
						paymentMethod.setCardNumber(oldPaymentMethod.getCardNumber());
						paymentMethod.setNickName(nickName);
						paymentMethod.setExpirationMonth(cardExpMonth);
						paymentMethod.setExpirationYear(cardExpYear);
						paymentMethod.setBillingAddressLine1(oldPaymentMethod.getBillingAddressLine1());
						paymentMethod.setBillingAddressLine2(oldPaymentMethod.getBillingAddressLine2());
						paymentMethod.setBillingCity(oldPaymentMethod.getBillingCity());
						paymentMethod.setBillingState(oldPaymentMethod.getBillingState());
						paymentMethod.setBillingZip(oldPaymentMethod.getBillingZip());
						paymentMethod.setBillingCountry(oldPaymentMethod.getBillingCountry());
						
						paymentMethodDao.save(paymentMethod);
					}else{
						errMsg.append("Action Code: "+jetPayPayment.getActCode()+" Response Text: "+jetPayPayment.getResponseText()+" ErrMsg: "+xpath.evaluate("/JetPayResponse/ErrMsg", document));
					}
				}
				
				if(jetPayPayment.getCcToken() != null && !jetPayPayment.getCcToken().equals("")){
					resp.append("SUCCESS__Token Number: "+jetPayPayment.getCcToken());
				}else{
					resp.append("FAILURE__Action Code: "+jetPayPayment.getActCode()+" Error Message: "+jetPayPayment.getResponseText());
				}
				
			} else {
				resp.append("FAILURE__");
				errMsg.append("Null response received.");
			}
		} catch (Exception e) {
			resp.append("FAILURE__");
			e.printStackTrace();
			errMsg.append("Exception: "+e.toString());
		} finally {
			jetPayPayment.setErrMsg(errMsg.toString());
			jetPayPaymentDao.save(jetPayPayment);
			post.releaseConnection();
		}
		return resp.toString();
	}
	
	@RequestMapping(value = "/processCardPaymentByToken", method = RequestMethod.POST)
	public @ResponseBody JetPayPayment processCardPaymentByToken(
			@RequestParam("token") String token,
			@RequestParam("amount") String amount,
			final HttpServletRequest request, final HttpServletResponse response) {
		// Prepare HTTP post
		PostMethod post = new PostMethod(Constants.JETPAY_XML_SCHEMA_URL);
		StringBuffer inputXMLStrBuffer = new StringBuffer("<JetPay>");
		inputXMLStrBuffer.append("<TransactionID>"+ RandomStringUtils.randomAlphanumeric(18) +"</TransactionID>");
		inputXMLStrBuffer.append("<TransactionType>"+ JetpayTransactionTypeEnum.SALE +"</TransactionType>");
		inputXMLStrBuffer.append("<Token>"+ token +"</Token>");
		inputXMLStrBuffer.append("<TotalAmount>"+ amount +"</TotalAmount>");
		inputXMLStrBuffer.append("<TerminalID>"+ Constants.JETPAY_TERMINAL_ID +"</TerminalID>");
		inputXMLStrBuffer.append("</JetPay>");

		post.setRequestEntity(new InputStreamRequestEntity(new StringBufferInputStream(inputXMLStrBuffer.toString())));
		post.setRequestHeader("Content-type", "text/xml; charset=ISO-8859-1");
		HttpClient httpclient = new HttpClient();
		JetPayPayment jetPayPayment = new JetPayPayment();
		try {
			httpclient.executeMethod(post);
			String xml = post.getResponseBodyAsString();
			if (xml != null) {

				InputSource source = new InputSource(new StringReader(xml));

				DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
				DocumentBuilder db = dbf.newDocumentBuilder();
				Document document = db.parse(source);

				XPathFactory xpathFactory = XPathFactory.newInstance();
				XPath xpath = xpathFactory.newXPath();

				jetPayPayment.setTransId(xpath.evaluate("/JetPayResponse/TransactionID", document));
				jetPayPayment.setActCode(xpath.evaluate("/JetPayResponse/ActionCode", document));
				jetPayPayment.setResponseText(xpath.evaluate("/JetPayResponse/ResponseText", document));
			}
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			post.releaseConnection();
		}
		return jetPayPayment;
	}
	
	// TODO: get card details and process with Tokanize = true
	@RequestMapping(value="/processCardPaymentAndTokennizeCard", method=RequestMethod.POST)
    public @ResponseBody JetPayPayment processCardPaymentAndTokennizeCard(@RequestParam("token") String token, @RequestParam("amount") String amount, final HttpServletRequest request, final HttpServletResponse response) {
	    // Prepare HTTP post
	    PostMethod post = new PostMethod(Constants.JETPAY_XML_SCHEMA_URL);	    
	    StringBuffer inputXMLStrBuffer = new StringBuffer("<JetPay>");
	    inputXMLStrBuffer.append("<TransactionID>"+RandomStringUtils.randomAlphanumeric(18)+"</TransactionID>");	
	    inputXMLStrBuffer.append("<TransactionType>"+JetpayTransactionTypeEnum.SALE+"</TransactionType>");       
	    inputXMLStrBuffer.append("<Token>"+token+"</Token>");
	    inputXMLStrBuffer.append("<TotalAmount>"+amount+"</TotalAmount>");
	    inputXMLStrBuffer.append("<TerminalID>"+Constants.JETPAY_TERMINAL_ID+"</TerminalID>");
	    inputXMLStrBuffer.append("</JetPay>");
	    
	    // Request content will be retrieved directly
	    // from the input stream
	    // Per default, the request content needs to be buffered
	    // in order to determine its length.
	    // Request body buffering can be avoided when
	    // content length is explicitly specified
	    post.setRequestEntity(new InputStreamRequestEntity(new StringBufferInputStream(inputXMLStrBuffer.toString())));
	    //, inputXMLStrBuffer.toString().length())

	    // Specify content type and encoding
	    // If content encoding is not explicitly specified
	    // ISO-8859-1 is assumed
	    post.setRequestHeader("Content-type", "text/xml; charset=ISO-8859-1");
	    // Get HTTP client
	    HttpClient httpclient = new HttpClient();
	    // Execute request
	    JetPayPayment jetPayPayment =  new JetPayPayment();
	    try {
	    	httpclient.executeMethod(post);
	        String xml = post.getResponseBodyAsString();  
	        if(xml != null){
	        	
	            InputSource source = new InputSource(new StringReader(xml));
	
	            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
	            DocumentBuilder db = dbf.newDocumentBuilder();
	            Document document = db.parse(source);
	
	            XPathFactory xpathFactory = XPathFactory.newInstance();
	            XPath xpath = xpathFactory.newXPath();  
	            
	            jetPayPayment.setTransId(xpath.evaluate("/JetPayResponse/TransactionID", document));
	            jetPayPayment.setActCode(xpath.evaluate("/JetPayResponse/ActionCode", document));
	            jetPayPayment.setResponseText(xpath.evaluate("/JetPayResponse/ResponseText", document));
	        }
	    } catch(Exception e){
	    	e.printStackTrace();
	    	
	    } finally {
	        // Release current connection to the connection pool 
	        // once you are done
	        post.releaseConnection();
	    }
		return jetPayPayment;
    }
	
	@RequestMapping(value = "/addBankInfoByTokenize", method = RequestMethod.POST)
	public @ResponseBody String addBankInfoByTokenize(
			@RequestParam("accountID") String accountID,
			@RequestParam("accountType") String accountType,
			@RequestParam("accountName") String accountName,
			@RequestParam("accountNumber") String accountNumber,
			@RequestParam("routingNumber") String routingNumber,
			//@RequestParam("checkNumber") String checkNumber,
			final HttpServletRequest request, final HttpServletResponse response) {
		StringBuffer resp = new StringBuffer();
		StringBuffer errMsg = new StringBuffer();
		PostMethod post = new PostMethod(Constants.JETPAY_XML_SCHEMA_URL);
		JetPayPayment jetPayPayment = new JetPayPayment();
		// Prepare HTTP post
		StringBuffer inputXMLStrBuffer = new StringBuffer();
		inputXMLStrBuffer.append("<JetPay>");
			inputXMLStrBuffer.append("<TransactionID>"+ RandomStringUtils.randomAlphanumeric(18) +"</TransactionID>");
			inputXMLStrBuffer.append("<TransactionType>"+ JetpayTransactionTypeEnum.TOKENIZE +"</TransactionType>");
			inputXMLStrBuffer.append("<TerminalID>"+ Constants.JETPAY_TERMINAL_ID +"</TerminalID>");
			inputXMLStrBuffer.append("<CardName>"+ accountName +"</CardName>");
			inputXMLStrBuffer.append("<ACH Type=\""+ACH_AccountTypeEnum.valueOf(accountType)+"\">");
				inputXMLStrBuffer.append("<AccountNumber>"+ accountNumber +"</AccountNumber>");
				inputXMLStrBuffer.append("<ABA>"+ routingNumber +"</ABA>");
				//inputXMLStrBuffer.append("<CheckNumber>"+ checkNumber +"</CheckNumber>");
			inputXMLStrBuffer.append("</ACH>");
		inputXMLStrBuffer.append("</JetPay>");

		post.setRequestEntity(new InputStreamRequestEntity(new StringBufferInputStream(inputXMLStrBuffer.toString())));
		post.setRequestHeader("Content-type", "text/xml; charset=ISO-8859-1");
		HttpClient httpclient = new HttpClient();
		try {
			httpclient.executeMethod(post);
			String xml = post.getResponseBodyAsString();

			// TODO: for testing
			jetPayPayment.setOldToken(xml);
			jetPayPayment.setCustomerEmail(inputXMLStrBuffer.toString());
			
			// parse response
			if (xml != null) {
				InputSource source = new InputSource(new StringReader(xml));
				DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
				DocumentBuilder db = dbf.newDocumentBuilder();
				Document document = db.parse(source);
				XPathFactory xpathFactory = XPathFactory.newInstance();
				XPath xpath = xpathFactory.newXPath();  

				String actionCode = xpath.evaluate("/JetPayResponse/ActionCode", document);
				if(actionCode != null && !actionCode.equals("")){
					jetPayPayment.setActCode(actionCode);
					jetPayPayment.setTransId(xpath.evaluate("/JetPayResponse/TransactionID", document));
					jetPayPayment.setResponseText(xpath.evaluate("/JetPayResponse/ResponseText", document));
					jetPayPayment.setCcToken(xpath.evaluate("/JetPayResponse/Token", document));
					
					if(actionCode.equals(Constants.PAYMENT_ACTION_CODE_SUCCESS) && (jetPayPayment.getCcToken() != null && !jetPayPayment.getCcToken().equals(""))){
						jetPayPayment.setApprCode(xpath.evaluate("/JetPayResponse/Approval", document));
						
						// persist new payment method
						PaymentMethod paymentMethod = new PaymentMethod();
						paymentMethod.setPaymentType(PaymentMethodTypeEnum.ACH.toString());
						paymentMethod.setPortalStatus(PortalStatusEnum.VP.toString());
						paymentMethod.setTokenNumber(jetPayPayment.getCcToken());
						paymentMethod.setTransId(jetPayPayment.getTransId());
						paymentMethod.setNickName("");
						paymentMethod.setCustomer(accountDao.findByAccountId(Long.valueOf(accountID)));
						if(accountNumber.length() > 4){
							paymentMethod.setCardNumber(Constants.CARD_MASKED_FIRST_DIGITS+accountNumber.substring(accountNumber.length() - 4));
						}else{
							paymentMethod.setCardNumber(Constants.CARD_MASKED_FIRST_DIGITS+accountNumber);
						}
						paymentMethodDao.save(paymentMethod);
					}else{
						errMsg.append("Action Code: "+jetPayPayment.getActCode()+" Response Text: "+jetPayPayment.getResponseText()+" ErrMsg: "+xpath.evaluate("/JetPayResponse/ErrMsg", document));
					}
				}
				
				if(jetPayPayment.getCcToken() != null && !jetPayPayment.getCcToken().equals("")){
					resp.append("SUCCESS__Token Number: "+jetPayPayment.getCcToken());
				}else{
					resp.append("FAILURE__Action Code: "+jetPayPayment.getActCode()+" Error Message: "+jetPayPayment.getResponseText());
				}
				
			} else {
				resp.append("FAILURE__");
				errMsg.append("Null response received.");
			}
		} catch (Exception e) {
			resp.append("FAILURE__");
			e.printStackTrace();
			errMsg.append("Exception: "+e.toString());
		} finally {
			jetPayPayment.setErrMsg(errMsg.toString());
			jetPayPaymentDao.save(jetPayPayment);
			post.releaseConnection();
		}
		return resp.toString();
	}
	
	//@RequestMapping(value = "/processEnquireRequestByTransactionId", method = RequestMethod.GET)
	/*public @ResponseBody JetPayPayment processEnquireRequestByTransactionId(
			@RequestParam("transactionId") String transactionId,
			final HttpServletRequest request, final HttpServletResponse response) {
		// Prepare HTTP post
		PostMethod post = new PostMethod(Constants.JETPAY_XML_SCHEMA_URL);
		StringBuffer inputXMLStrBuffer = new StringBuffer("<JetPay>");
		inputXMLStrBuffer.append("<TransactionID>"+ RandomStringUtils.randomAlphanumeric(18)+ "</TransactionID>");
		inputXMLStrBuffer.append("<TransactionType>"+ JetpayTransactionTypeEnum.SALE + "</TransactionType>");
		inputXMLStrBuffer.append("<Token>" + token + "</Token>");
		inputXMLStrBuffer.append("<TotalAmount>" + amount + "</TotalAmount>");
		inputXMLStrBuffer.append("<TerminalID>" + Constants.JETPAY_TERMINAL_ID + "</TerminalID>");
		inputXMLStrBuffer.append("</JetPay>");

		post.setRequestEntity(new InputStreamRequestEntity(
				new StringBufferInputStream(inputXMLStrBuffer.toString())));
		post.setRequestHeader("Content-type", "text/xml; charset=ISO-8859-1");
		HttpClient httpclient = new HttpClient();
		JetPayPayment jetPayPayment = new JetPayPayment();
		try {
			int result = httpclient.executeMethod(post);
			String xml = post.getResponseBodyAsString();
			if (xml != null) {

				InputSource source = new InputSource(new StringReader(xml));

				DocumentBuilderFactory dbf = DocumentBuilderFactory
						.newInstance();
				DocumentBuilder db = dbf.newDocumentBuilder();
				Document document = db.parse(source);

				XPathFactory xpathFactory = XPathFactory.newInstance();
				XPath xpath = xpathFactory.newXPath();

				jetPayPayment.setTransId(xpath.evaluate(
						"/JetPayResponse/TransactionID", document));
				jetPayPayment.setActCode(xpath.evaluate(
						"/JetPayResponse/ActionCode", document));
				jetPayPayment.setResponseText(xpath.evaluate(
						"/JetPayResponse/ResponseText", document));
			}
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			post.releaseConnection();
		}
		return jetPayPayment;
	}*/
	
	/*@RequestMapping(value="/getPaymentMethodForPaymentId/{paymentId}", method=RequestMethod.GET)
    public @ResponseBody PaymentMethod getPaymentMethodForPaymentId(@PathVariable Long paymentId, final HttpServletRequest request, final HttpServletResponse response) { 
		Model model = new ExtendedModelMap();
		List<PaymentMethod> paymentMethod = paymentMethodDao.getPaymentMethodByPaymentId(paymentId);
        try {
            model.addAttribute("paymentMethod", new PaymentMethod());
            if(paymentMethod != null && !paymentMethod.isEmpty()){
            	PaymentMethod pm = paymentMethod.get(0);
            	Account customer =  new Account();
            	customer.setAccountId(pm.getCustomer().getAccountId());
            	pm.setCustomer(customer);
            	return pm;
            }
            
       } catch (Exception se) {
            System.out.println("Error occoured");
            se.printStackTrace();
       }
       return null;
    }*/
	
	
	@RequestMapping(value = "/removePaymentMethod", method = RequestMethod.POST)
	public @ResponseBody String removePaymentMethod(
			@RequestParam(value = "accountID") String accountID,
			@RequestParam(value = "token") String token,
			final HttpServletRequest request, final HttpServletResponse response) {
		JSONArray json = new JSONArray();
		List<Signup> signUpList = new ArrayList<Signup>();
		try {
			System.out.println(" token "+token);
			PaymentMethod paymentMethod = paymentMethodDao.getPaymentMethodByTokenNumber(token);
			
			// TODO: check for any recurring payment
			System.out.println(" AccountId :: "+accountID+"  PaymentId :: "+paymentMethod.getPaymentId());
			Account account = accountDao.findByAccountId(Long.valueOf(accountID));
			List<Signup> signupList = signupDao.getByCustomerAndPaymentMethod(account, paymentMethod.getPaymentId());
			
			if(signupList != null && signupList.size() > 0){
				System.out.println(" # of Signups :: "+signupList.size());
				boolean addSignupToList = false;
				double totalOpenBalanceForSignUp = 0;
				for (Signup signup : signupList) {
					addSignupToList = false;
					totalOpenBalanceForSignUp = 0;
					List<Invoice> invoiceList = invoiceDao.getInvoiceListForSignup(signup.getSignupId());
					if(invoiceList != null && invoiceList.size() > 0){
						System.out.println(" # of Invoices for signupId "+signup.getSignupId()+" :: "+invoiceList.size());
						for (Invoice invoice : invoiceList) {
							// get balance for the invoice
							double openBalance = getOpenBalanceForInvoice(invoice);
							System.out.println(" openBalance ::  "+openBalance);
							if(openBalance > 0){
								addSignupToList = true;
								totalOpenBalanceForSignUp += openBalance;
							}
						}
					}else{
						// No invoices for signup
						System.out.println(" No invoices for the signup :: "+signup.getSignupId());
					}
					
					if(addSignupToList){
						System.out.println(" Add signup to list signupid "+signup.getSignupId()+" with total due :: "+totalOpenBalanceForSignUp);
						signUpList.add(signup);
					}
				}
			}
			
			if(signUpList != null && signUpList.size() > 0){
				System.out.println("Cannnot Delete payment method you selected ............ ");
				for(Signup signup: signUpList){
			    	JSONObject obj = new JSONObject();
			    	obj.put("SignupId", signup.getSignupId());
			    	obj.put("SignupName", signup.getSignUpName());
			    	obj.put("SignupDate", DateFormatUtils.format(signup.getSignupDate(), "MM/dd/yyyy"));
					json.add(obj);
		    	}
			}else{
				System.out.println("Delete payment method ............ ");
				paymentMethod.setPortalStatus(PortalStatusEnum.INACTIVE.toString());
				paymentMethodDao.save(paymentMethod);
			}
			
		} catch (Exception se) {
			System.out.println("Error occoured");
			se.printStackTrace();
		}
		return json.toString();
	}
	
	private double getOpenBalanceForInvoice(Invoice invoice){
		double openBalanceOnInvoice = 0, trueInvoiceValue = 0, sumOfDebitPayment = 0, sumOfCreditMemoFAWaiver = 0, sumOfCreditMemoWaiver = 0;
		double sumOfCreditMemoWriteOff = 0, sumOfCreditMemoRefund = 0, sumOfNSF = 0, sumOfChargeBack = 0;
		
		List<Payment> payments = paymentDao.getPaymentListForInvoice(invoice.getInvoiceId());
		for (Payment payment : payments) {
			System.out.println(" Type : "+payment.getType()+ " TypeEnum : "+PaymentTypeEnum.valueOf(payment.getType())+" Amount : "+payment.getAmount());
			switch (PaymentTypeEnum.getEnumByString(payment.getType())) {
				
				case CreditMemoFAWaiver:
					sumOfCreditMemoFAWaiver += payment.getAmount();
					break;
				case CreditMemoWaiver:
					sumOfCreditMemoWaiver += payment.getAmount();
					break;
				case CreditMemoRefund:
					sumOfCreditMemoRefund += payment.getAmount();
					break;
				case CreditMemoWriteOff:
					sumOfCreditMemoWriteOff += payment.getAmount();
					break;
				case Debit:
					sumOfDebitPayment += payment.getAmount();
					break;
				case NSF:
					sumOfNSF += payment.getAmount();
					break;
				case ChargeBack:
					sumOfChargeBack += payment.getAmount();
					break;
				default:
					break;
			}
		}
		
		System.out.println(" sumOfCreditMemoFAWaiver  "+sumOfCreditMemoFAWaiver);
		System.out.println(" sumOfCreditMemoWaiver  "+sumOfCreditMemoWaiver);
		System.out.println(" sumOfCreditMemoRefund  "+sumOfCreditMemoRefund);
		System.out.println(" sumOfCreditMemoWriteOff  "+sumOfCreditMemoWriteOff);
		System.out.println(" sumOfDebitPayment  "+sumOfDebitPayment);
		System.out.println(" sumOfNSF  "+sumOfNSF);
		System.out.println(" sumOfChargeBack  "+sumOfChargeBack);
		
		trueInvoiceValue = invoice.getAmount() - (sumOfCreditMemoWaiver + sumOfCreditMemoFAWaiver + sumOfCreditMemoWriteOff);
		System.out.println(" trueInvoiceValue "+trueInvoiceValue);
		
		openBalanceOnInvoice = trueInvoiceValue - (sumOfDebitPayment + sumOfCreditMemoRefund) + ((sumOfNSF > 0 ? sumOfNSF : sumOfChargeBack));
		System.out.println(" openBalanceOnInvoice "+openBalanceOnInvoice);
		
		return openBalanceOnInvoice;
	}
	
	
	@RequestMapping(value = "/isCardAlreadyExist", method = RequestMethod.GET)
	public @ResponseBody String isCardAlreadyExist(
			@RequestParam(value = "accountID") String accountID,
			@RequestParam(value = "cardNumber") String cardNumber,
			@RequestParam(value = "expMonth") String expMonth,
			@RequestParam(value = "expYear") String expYear,
			final HttpServletRequest request, final HttpServletResponse response) {
		JSONObject json = new JSONObject();
		try {
			String last4Digits = cardNumber.substring(cardNumber.length() - 4);
			cardNumber = Constants.CARD_MASKED_FIRST_DIGITS+last4Digits;
			Long paymentId = paymentMethodDao.isCardAlreadyExist(Long.valueOf(accountID), cardNumber, expMonth, expYear);
			if(paymentId != null && paymentId > 0){
				json.put("paymentId", paymentId);
			}else{
				json.put("paymentId", 0);
			}
		} catch (Exception se) {
			System.out.println("Error occoured");
			se.printStackTrace();
		}
		return json.toString();
	}
	
	@RequestMapping(value = "/isBankInfoAlreadyExist", method = RequestMethod.GET)
	public @ResponseBody String isBankInfoAlreadyExist(
			@RequestParam(value = "accountID") String accountID,
			@RequestParam(value = "bankAccountNumber") String bankAccountNumber,
			final HttpServletRequest request, final HttpServletResponse response) {
		JSONObject json = new JSONObject();
		try {
			String last4Digits = bankAccountNumber.substring(bankAccountNumber.length() - 4);
			bankAccountNumber = Constants.CARD_MASKED_FIRST_DIGITS+last4Digits;
			Long paymentId = paymentMethodDao.isBankInfoAlreadyExist(Long.valueOf(accountID), bankAccountNumber);
			if(paymentId != null && paymentId > 0){
				json.put("paymentId", paymentId);
			}else{
				json.put("paymentId", 0);
			}
		} catch (Exception se) {
			System.out.println("Error occoured");
			se.printStackTrace();
		}
		return json.toString();
	}
	
	@RequestMapping(value = "/getPaymentMethodOptionsForAccount", method = RequestMethod.GET)
	public @ResponseBody String getPaymentMethodOptionsForAccount(
			@RequestParam(value = "accountID") String accountID,
			final HttpServletRequest request, final HttpServletResponse response) {
		JSONObject json = new JSONObject();
		try {
			Account account = accountDao.findByAccountId(Long.valueOf(accountID));
			List<PaymentMethod> paymentMethodList = paymentMethodDao.getPaymentMethodListForAccount(account);
			if(paymentMethodList != null && paymentMethodList.size() > 0){
				for (PaymentMethod paymentMethod : paymentMethodList) {
					json.put(paymentMethod.getTokenNumber(), paymentMethod.getCardNumber());
				}
			}else{
				json.put("", "");
			}
		} catch (Exception se) {
			System.out.println("Error occoured");
			se.printStackTrace();
		}
		return json.toString();
	}
	
	
	@RequestMapping(value = "/updatePaymentMethodForSignup", method = RequestMethod.POST)
	public @ResponseBody String updatePaymentMethodForSignup(
			@RequestParam(value = "token") String token,
			@RequestParam(value = "signupid") String signupid,
			@RequestParam(value = "accountID") String accountID,
			final HttpServletRequest request, final HttpServletResponse response) {
		JSONObject json = new JSONObject();
		try {
			
			System.out.println(" token "+token);
			System.out.println(" signupid "+signupid);
			System.out.println(" accountID "+accountID);
			
			Account customer = accountDao.findByAccountId(Long.valueOf(accountID));
			PaymentMethod paymentMethod = paymentMethodDao.getPaymentMethodByTokenNumber(token);
			if(signupid.endsWith("_")){
				
				if (signupid.charAt(signupid.length()-1)=='_'){
					signupid = signupid.substring(0, signupid.lastIndexOf("_"));
			    }
				
				String[] signupList = signupid.split("_");
				
				System.out.println(" signupList.length "+signupList.length);
				
				if(signupList.length > 0){
					
					for (int i = 0; i < signupList.length; i++) {
						String signupTemp = signupList[i];
						Signup signup = signupDao.findByCustomerAndSignupId(customer, Long.valueOf(signupTemp));
						signup.setPaymentMethod(paymentMethod);
						signupDao.save(signup);
						System.out.println("  if signup.getSignupId()  "+signup.getSignupId());
					}
					
				}
			}else{
				Signup signup = signupDao.findByCustomerAndSignupId(customer, Long.valueOf(signupid));
				signup.setPaymentMethod(paymentMethod);
				signupDao.save(signup);
				System.out.println("  else signup.getSignupId()  "+signup.getSignupId());
			}
			json.put("RESULT", "SUCCESS");
		} catch (Exception se) {
			System.out.println("Error occoured");
			se.printStackTrace();
			json.put("RESULT", "FAILURE");
		}
		return json.toString();
	}
}
